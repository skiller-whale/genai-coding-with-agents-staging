#!/bin/sh
set -e

if [ -z "$1" ]; then
  echo "Usage: checkpoint <CHECKPOINT_NAME>"
  exit 1
fi

CHECKPOINT=$(echo "$1" | tr '[:upper:]' '[:lower:]')
HOME=/home/learner
WORKING_FOLDER_NAME=${DEFAULT_FOLDER:-_code}
WORKING_DIR="$HOME/$WORKING_FOLDER_NAME"
CHECKPOINTS_DIR="$HOME/checkpoint"

printf "This will clear your code in app/ and replace it with checkpoint '%s'. Are you sure? (y/n) " "$CHECKPOINT"
read answer
echo
case "$answer" in
  y|Y) ;;
  *) echo "Aborted."; exit 1 ;;
esac

cd "$WORKING_DIR" || exit 1
git worktree remove -f "$CHECKPOINTS_DIR" 2> /dev/null || true

git worktree add "$CHECKPOINTS_DIR" "checkpoint-$CHECKPOINT"

find app -mindepth 1 -delete
cp -a "$CHECKPOINTS_DIR/app/." app/
cd app || exit 1
git init

git worktree remove --force "$CHECKPOINTS_DIR" 2> /dev/null || true

echo
echo "Checkpoint '$CHECKPOINT' loaded successfully."
echo "For good results, now:"
echo "  1. Close and reopen all claudes and terminals."
echo "  2. Click refresh in the file explorer."
